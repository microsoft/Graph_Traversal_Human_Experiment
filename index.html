<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Planning Puzzles — TSP Template</title>

  <!-- Load the move and change states (kept for structure; not shown in trials) -->

  <script src="TSP_stimuli_b1_copy.js"></script>
  <script src="TSP_stimuli_b2_copy.js"></script>

  <!-- FileSaver for saving files -->
  <script src="https://cdn.jsdelivr.net/npm/file-saver"></script>

  <!-- JSZip for bundling puzzle logs + audio into one download -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: #f9f9f9;
      color: #333;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .site-footer {
      background-color: #f1f1f1;
      border-top: 1px solid #ccc;
      padding: 6px 20px;
      text-align: center;
      font-size: 0.8rem;
      color: #555;
      margin-top: auto; /* pushes footer to bottom */
      width: 100%;
    }

    .footer-content {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      align-items: flex-start;
      width: 100%;
      max-width: 1200px;
    }

    .left-column {
      max-width: 420px;
      flex-shrink: 1;
      background-color: #ffffff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      /* Remove min-height - let content determine height */
    }

    .stim-prompt{
      margin-top:12px;
      padding:10px 12px;
      border:1px solid #cfd8dc;
      border-radius:6px;
      background:#fafafa;
    }

    /* Style both practice and trial textareas the same */
    .notes-textarea, .practice-textarea{
      width:100%;
      min-height:260px;
      resize:vertical;
      padding:12px;
      font-size:16px;
      line-height:1.4;
      border:1px solid #cfd8dc;
      border-radius:6px;
      box-sizing:border-box;
    }
    .notes-textarea:focus, .practice-textarea:focus{
      outline:none;
      border-color:#42a5f5;
      box-shadow:0 0 0 3px rgba(66,165,245,.25);
    }

    .right-column {
      max-width: 700px;
      flex-shrink: 1;
      flex: 2;
      background-color: #ffffff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      /* Remove min-height - let content determine height */
      display: flex;
      flex-direction: column;
      justify-content: center; /* center the Continue button in the white space */
      align-items: center;
      min-height: 280px; /* keep a pleasant white space area */
    }

    /* Countdown badge shown during trials (kept for structure; hidden in UI) */
    .trial-timer {
      align-self: flex-end;
      margin-bottom: 8px;
      padding: 6px 12px;
      border-radius: 9999px;
      border: 1px solid #a5d6a7;
      background: #e8f5e9;
      color: #1b5e20;
      font-weight: 600;
      font-size: 20px;
      letter-spacing: .5px;
      font-variant-numeric: tabular-nums;
    }
    .trial-timer.warning {
      border: 1px solid #ffe082;
      background: #fff8e1;
      color: #8d6e63;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }
    .trial-timer.urgent {
      background: #ffebee;
      border-color: #ef9a9a;
      color: #b71c1c;
    }

    .rules-text {
      border-left: 6px solid #42a5f5;
      font-size: 0.95rem;
      padding-left: 12px;
      margin-bottom: 20px;
    }

    .state-display {
      font-size: 16px;
      margin: 12px 0;
      background-color: #f4faff;
      padding: 10px 12px;
      border-radius: 6px;
      border-left: 4px solid #42a5f5;
    }

    .done-button {
      font-size: 14px;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      background-color: #42a5f5;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .done-button:hover { background-color: #1e88e5; }

    .center { text-align: center; }

    /* Intro, instructions, error, end screens */
    #intro-screen, #instructions-screen, #end-screen {
      max-width: 600px;
      background-color: #ffffff;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      display: none;
    }

    #end-screen { text-align: center; }

    #error-message {
      display: none;
      max-width: 600px;
      color: #B00020;
      background-color: #ffe6e6;
      padding: 12px 16px;
      margin-bottom: 20px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #F44336;
    }



  </style>
</head>
<body>

  <!-- Inline error message (replaces native alerts) -->
  <div id="error-message"></div>

  <!-- Container for transient voice prompt banner (inserted dynamically) -->
  <!-- <div id="prompt-message"></div> created by ensurePromptBanner() -->

  <!-- Container for the multi-step intro screens -->
  <div id="intro-screen"></div>

  <!-- Container for per-block instructions -->
  <div id="instructions-screen"></div>

  <!-- The main task UI (blank left/right columns during trials) -->
  <div id="task-ui" class="container" style="display: none;"></div>

  <!-- The final end screen -->
  <div id="end-screen">
    <p style="margin-bottom: 24px; font-size: 18px;">
      The study is now complete.<br>
      Press any key to receive payment.
    </p>
  </div>

  <script type="module">
    // --------------------------------------
    // GLOBAL CONFIG
    // --------------------------------------
    const N = 2; // N problems per block

    // Randomly sample starting states
    function getRandomIndices(len, exclude = [], count = 5) {
      const idxs = [];
      while (idxs.length < count) {
        const i = Math.floor(Math.random() * len);
        if (!idxs.includes(i) && !exclude.includes(i)) idxs.push(i);
      }
      return idxs;
    }

    const moveBlock = Array.from({ length: N }, () => ({}));
    const changeBlock = Array.from({ length: N }, () => ({}));

    // Decide order of blocks randomly
    const blocks = ['move','change'];
    const blockData = { move: moveBlock, change: changeBlock };

    let blockIndex = 0; // which block (0 or 1)
    let trialIndex = 0; // which trial (0..N-1)

    // Build per-block random prompts (N per block) from the correct stimulus set
    const movePrompts   = buildPromptsWithConstraints(TSP_STIMULI_B1, N);
    const changePrompts = buildPromptsWithConstraints(TSP_STIMULI_B2, N);
    let currentPrompt = null;
    const promptData = { move: movePrompts, change: changePrompts };

    // puzzle state and logs
    let currentState = {};
    let userActions = [];
    let allProblemLogs = [];


    // participant info
    let participantData = { agreement:'', gender:'', age:'' };

    // problem start timestamp
    let problemStartTime = null;


    // --------------------------------------
    // FIREBASE CONFIGURATION
    // --------------------------------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBmwVKrctSe5uCf_mUk0fX98PU0bfBfZ_k",
      authDomain: "tsp-experiment-storage.firebaseapp.com",
      projectId: "tsp-experiment-storage",
      storageBucket: "tsp-experiment-storage.firebasestorage.app",
      messagingSenderId: "705114542213",
      appId: "1:705114542213:web:c08d81670f40055ff5d9ec",
      measurementId: "G-64EMG37V4C"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    // --------------------------------------
    // HELPERS
    // --------------------------------------

    function showError(msg) {
      const err = document.getElementById('error-message');
      err.textContent = msg;
      err.style.display = 'block';
      setTimeout(() => err.style.display = 'none', 3000);
    }

    // Build a prompt list with constraints…
    function buildPromptsWithConstraints(stimuli, N) {
      const pool = stimuli.slice();
      for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
      }

      const bySize = { 4: [], 5: [], 6: [] };
      pool.forEach(s => {
        const n = s?.cities?.length;
        if (bySize[n]) bySize[n].push(s);
      });

      const out = [];

      const removeFrom = (size, stim) => {
        const arr = bySize[size];
        if (!arr) return;
        const idx = arr.indexOf(stim);
        if (idx > -1) arr.splice(idx, 1);
      };

      const takeOneFromSizes = (sizes) => {
        const bag = [];
        sizes.forEach(sz => { if (bySize[sz]?.length) bag.push(...bySize[sz]); });
        if (!bag.length) return null;
        const chosen = bag[Math.floor(Math.random() * bag.length)];
        removeFrom(chosen.cities.length, chosen);
        return chosen;
      };

      let pick = takeOneFromSizes([4]);
      if (!pick) { console.warn("No 4-city for first trial; relaxing."); pick = takeOneFromSizes([5,6]); }
      if (pick) out.push(pick);

      pick = takeOneFromSizes([4,5]);
      if (!pick) { console.warn("No 4/5-city for second trial; relaxing."); pick = takeOneFromSizes([6]); }
      if (pick) out.push(pick);

      while (out.length < Math.min(N, stimuli.length)) {
        const prev = out[out.length - 2]?.cities?.length;
        const last = out[out.length - 1]?.cities?.length;

        let allowed = [4, 5, 6];

        if (last === 6) allowed = allowed.filter(s => s !== 6);
        if (prev === 5 && last === 6) allowed = allowed.filter(s => s !== 5);
        if (prev === 6 && last === 5) allowed = allowed.filter(s => s !== 6);

        pick = takeOneFromSizes(allowed);

        if (!pick && prev === 5 && last === 6) {
          console.warn("Relaxing 5-6-5 ban due to pool exhaustion.");
          pick = takeOneFromSizes([5]);
        }
        if (!pick && prev === 6 && last === 5) {
          console.warn("Relaxing 6-5-6 ban due to pool exhaustion.");
          pick = takeOneFromSizes([6]);
        }

        if (!pick && last === 6) {
          console.warn("Relaxing 6-6 ban due to pool exhaustion.");
          pick = takeOneFromSizes([6]);
        }

        if (!pick) pick = takeOneFromSizes([4,5,6]);
        if (!pick) break;

        out.push(pick);
      }

      return out.slice(0, N);
    }


    // ---- Trial timer (limit based on cities) ----
    let countdownInterval = null;
    let countdownDeadline = 0;
    let trialActive = false; // guards against double-ending

    function formatClock(ms) {
      const total = Math.ceil(ms / 1000);
      const m = Math.max(0, Math.floor(total / 60));
      const s = Math.max(0, total % 60);
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    function updateTimerDisplay() {
      // Compute remaining time regardless of whether the visual timer exists
      const remaining = Math.max(0, countdownDeadline - Date.now());

      // Update the (hidden) timer UI only if present
      const el = document.getElementById('trial-timer');
      if (el) {
        el.textContent = formatClock(remaining);
        const secs = Math.ceil(remaining / 1000);
        el.classList.toggle('urgent',  secs <= URGENT_THRESHOLD_S);
        el.classList.toggle('warning', secs >  URGENT_THRESHOLD_S && secs <= WARNING_THRESHOLD_S);
      }

      if (remaining <= 0) {
        clearTrialTimer();
        endTrial('timeout');
      }
    }

    function getTrialLimitMsFromCities(count) {
      const secsByCities = { 4: 45, 5: 60, 6: 90 }; // seconds
      const seconds = secsByCities[count] ?? 15;
      return seconds * 1000;
    }

    function startTrialTimer(limitMs) {
      if (typeof limitMs !== 'number') throw new Error('startTrialTimer requires limitMs');
      clearTrialTimer();
      countdownDeadline = Date.now() + limitMs;

      const el = document.getElementById('trial-timer');
      if (el) el.classList.remove('urgent', 'warning');

      updateTimerDisplay();
      countdownInterval = setInterval(updateTimerDisplay, 250);
    }

    const WARNING_THRESHOLD_S = 20;
    const URGENT_THRESHOLD_S  = 10;

    function clearTrialTimer() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }

    // --------------------------------------
    // AUDIO RECORDING
    // --------------------------------------
    let audioStream = null;
    let recorder = null;
    const audioChunks = []; // {block, trial, blob}

    async function requestAudioPermission() {
      try {
        audioStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      } catch (e) {
        console.error(e);
        showError("Microphone access is needed to record your responses.");
      }
    }

    function startRecording(blockNum, trialNum) {
      if (!audioStream) return;
      recorder = new MediaRecorder(audioStream);
      recorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push({ block:blockNum, trial:trialNum, blob:e.data });
      };
      recorder.start();
    }

    function stopRecording(cb) {
      if (!recorder) { cb && cb(); return; }
      recorder.onstop = () => { cb && cb(); };
      recorder.stop();
      recorder = null;
    }

    // =============================
    // LIVE VOICE FEEDBACK MODULE
    function ensurePromptBanner() {
      let el = document.getElementById("prompt-message");
      if (!el) {
        el = document.createElement("div");
        el.id = "prompt-message";
        el.style.display = "none";
        el.style.maxWidth = "600px";
        el.style.margin = "0 0 20px 0";
        el.style.background = "#E3F2FD";
        el.style.color = "#0D47A1";
        el.style.border = "1px solid #90CAF9";
        el.style.borderRadius = "8px";
        el.style.padding = "12px 16px";
        el.style.textAlign = "center";
        const anchor = document.querySelector('#error-message');
        (anchor?.parentNode || document.body).insertBefore(el, anchor?.nextSibling || null);
      }
      return el;
    }

    function showPrompt(msg, ms = 4000) {
      const el = ensurePromptBanner();
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(showPrompt._t);
      showPrompt._t = setTimeout(() => (el.style.display = "none"), ms);
    }

    const VoiceFeedback = (() => {
      let ctx = null;
      let source = null;
      let analyser = null;
      let freqData = null;
      let running = false;
      let timer = null;

      const cfg = {
        intervalSec: 20,
        threshold: .0008,
        minHz: 85,
        maxHz: 255,
        fftSize: 2048,
        smoothing: 0.8,
      };

      let accum = 0;
      let frames = 0;
      let minBin = 0, maxBin = 0;

      function setupBins(sampleRate, fftSize) {
        const binHz = sampleRate / fftSize;
        minBin = Math.floor(cfg.minHz / binHz);
        maxBin = Math.ceil(cfg.maxHz / binHz);
      }

      function sampleLoop() {
        if (!running) return;
        analyser.getFloatFrequencyData(freqData);
        let total = 0;
        for (let i = minBin; i <= maxBin && i < freqData.length; i++) {
          total += Math.pow(10, freqData[i] / 20);
        }
        const avg = total / Math.max(1, (maxBin - minBin + 1));
        accum += avg;
        frames += 1;
        requestAnimationFrame(sampleLoop);
      }

      async function start() {
        if (running) return;
        if (!audioStream) return;
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        await ctx.resume().catch(()=>{});
        source = ctx.createMediaStreamSource(audioStream);

        analyser = ctx.createAnalyser();
        analyser.fftSize = cfg.fftSize;
        analyser.smoothingTimeConstant = cfg.smoothing;

        freqData = new Float32Array(analyser.frequencyBinCount);
        source.connect(analyser);

        setupBins(ctx.sampleRate, analyser.fftSize);
        accum = 0; frames = 0; running = true;
        sampleLoop();

        timer = setInterval(() => {
          if (!running) return;
          const avgActivity = frames ? (accum / frames) : 0;
          if (avgActivity < cfg.threshold) {
            showPrompt("Please keep speaking your thoughts aloud.");
          }
          console.debug('avgActivity', avgActivity.toFixed(5));
          accum = 0; frames = 0;
        }, cfg.intervalSec * 1000);
      }

      async function stop() {
        running = false;
        clearInterval(timer);
        try { source && source.disconnect(); } catch (_) {}
        try { ctx && (await ctx.close()); } catch (_) {}
        ctx = source = analyser = null;
        freqData = null;
        accum = 0; frames = 0;
      }

      function setConfig(overrides) { Object.assign(cfg, overrides || {}); }
      return { start, stop, setConfig, cfg };
    })();


    // --------------------------------------
    // INTRO SCREENS
    // --------------------------------------
    let introIndex = 0;
    const introScreens = [
      // 0
      `
        <p>In this study, you will solve problems involving identifying the shortest path between cities.</p>
        <p>Only anonymous data without any personal information will be stored for research purposes.</p>
        <p>Audio will also be recorded while you solve the problems.</p>
        <p>The whole study will take no longer than 1 hour to complete.</p>
        <p>If you agree to participate in the study, please respond by typing something in the box provided below.</p>
        <p>Otherwise, please close the study window.</p>
        <p><input type="text" id="agreeInput" style="width: 95%;" placeholder="Type your response here..."></p>
      `,
      // 1
      `
        <p>Please provide the following information.</p>
        <p>Gender:</p>
        <p>
          <select id="genderSelect" style="width: 100%;">
            <option value="" disabled selected hidden>Select...</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Nonbinary">Nonbinary</option>
            <option value="Other">Other (please specify)</option>
          </select>
        </p>
        <p id="otherGenderWrapper" style="display:none;">
          <input type="text" id="otherGenderInput" style="width: 95%;" placeholder="Please specify..." />
        </p>
        <p>Age:</p>
        <p><input type="number" id="ageInput" style="width: 95%;" placeholder="Type your age here..." /></p>
      `,
      // 2
      `
        <p>Please turn off any music or potential sources of distraction.</p>
        <p>The experiment will switch to full screen mode when you press the button below.</p>
        <p>Please remain in full screen mode until the experiment is complete.</p>
        <p>Microphone access will also be requested for audio recording.</p>
      `,
      // 3
      `
        <p>The experiment will consist of two blocks problems where you identify the shortest path between rooms. Each block will contain ${N} problems.</p>
        <p>Before the first block, you will be presented with instructions.</p>
        <p>You will have a brief period to rest in between the first and second blocks.</p>
        <p>Please press 'Next' to see the instructions for Block #1.</p>
      `
    ];

    function startIntro() {
      introIndex = 0;
      showIntroScreen();
    }

    function showIntroScreen() {
      const introDiv = document.getElementById('intro-screen');
      introDiv.innerHTML = introScreens[introIndex] + `
        <div style="text-align: center; margin-top: 24px;">
          <button id="introNextBtn" style="padding: 10px 20px;">Next</button>
        </div>
      `;
      introDiv.style.display = 'block';

      document.getElementById('introNextBtn').addEventListener('click', handleIntroNext);

      if (introIndex === 1) {
        const sel = document.getElementById('genderSelect');
        sel.addEventListener('change', () => {
          document.getElementById('otherGenderWrapper').style.display =
            sel.value === 'Other' ? 'block' : 'none';
        });
      }
    }

    async function handleIntroNext() {
      if (introIndex === 0) {
        const val = document.getElementById('agreeInput').value.trim();
        if (!val) { showError("Please type something to proceed."); return; }
        participantData.agreement = val;

      } else if (introIndex === 1) {
        const gSel = document.getElementById('genderSelect');
        const age = document.getElementById('ageInput').value.trim();
        if (!gSel.value || !age) {
          showError("Please select a gender and enter your age."); return; }
        if (gSel.value === 'Other') {
          const spec = document.getElementById('otherGenderInput').value.trim();
          if (!spec) { showError("Please specify your gender."); return; }
          participantData.gender = spec;
        } else {
          participantData.gender = gSel.value;
        }
        participantData.age = age;

      } else if (introIndex === 2) {
        if (document.body.requestFullscreen) document.body.requestFullscreen();
        else if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
        await requestAudioPermission();
      }

      introIndex++;
      if (introIndex < introScreens.length) {
        showIntroScreen();
      } else {
        document.getElementById('intro-screen').style.display = 'none';
        loadBlock();
      }
    }

    // --------------------------------------
    // PER-BLOCK INSTRUCTIONS
    // --------------------------------------
    function loadBlock() {
      const blockNum = blockIndex + 1;
      const blockType = blocks[blockIndex];
      if (blockType === 'move') showMoveInstructions(blockNum);
      else showChangeInstructions(blockNum);
    }

    function showMoveInstructions(blockNumber) {
      const inst = document.getElementById('instructions-screen');
      inst.style.display = 'block';
      inst.innerHTML = `
        <h2>Experiment Instructions (for both blocks)</h2>
        <p>In this experiment, you will be presented with sets of cities. Your goal is to find the shortest path between two cities in the specified layout</p>
        <p style="font-size:1.15rem;"><strong>Importantly, as you are solving the problems, try to say out loud everything that goes through your mind.</strong></p>
        <p style="font-size:1.15rem;"><strong>If you are silent for a long period of time, we will send you a reminder to speak your thoughts aloud.</strong></p>
        <p>There will be ${N} problems in each block.</p>
        <div style="text-align:center;margin-top:24px;">
          <button id="begin-block-btn" style="padding:10px 20px;">Continue to Practice Trial</button>
        </div>
      `;
      document.getElementById('begin-block-btn').addEventListener('click', () => {
        showMoveRuleCheck(blockNumber);
      });
    }

    // Rule check (simplified right column: only Continue)
    function showMoveRuleCheck(blockNumber) {
      const inst = document.getElementById('instructions-screen');
      inst.style.display = 'none';

      const container = document.getElementById('task-ui');
      container.style.display = 'flex';

      // Left-column practice text + example distance table
      const leftHTML = `
        <div class="rules-text">
          <h3>Example Trial (Practice)</h3>
          <h3>Instructions</h3>
          <p>In this experiment, you will be presented with sets of cities. Your goal is to find the shortest path between two cities in the specified layout</p>
          <p>Once you feel comfortable with the format and have typed in a Final Path, press <strong>Continue</strong> to begin the experiment.</p>
        </div>
      `;

      container.innerHTML = `
        <div class="left-column">${leftHTML}</div>
        <div class="right-column" style="justify-content:flex-start;">
          <textarea id="practice-notes"
            aria-label="Practice typing area"
            placeholder="Type your thoughts here…"
            class="practice-textarea"></textarea>

          <div class="center" style="margin-top:12px;">
            <button id="move-check-continue-btn" class="done-button">Continue (Begin Experiment)</button>
          </div>
        </div>
      `;

    const continueBtn = container.querySelector('#move-check-continue-btn');
    continueBtn.addEventListener('click', () => {
      participantData.practiceNotes = (document.getElementById('practice-notes')?.value || '').trim();
      startBlock();
    });
  }


    function showChangeInstructions(blockNumber) {
      const inst = document.getElementById('instructions-screen');
      inst.style.display = 'block';
      inst.innerHTML = `
        <h2>Please take a brief rest before continuing to Block #${blockNumber}</h2>
        <p>In this block, you will continue solving shortest-path style problems.</p>
        <p>As you solve the problems, please continue to describe your thought process out loud.</p>
        <p>There will be ${N} problems in this block.</p>
        <div style="text-align:center;margin-top:24px;">
          <button id="begin-block-btn" style="padding:10px 20px;">Begin block</button>
        </div>
      `;
      document.getElementById('begin-block-btn').addEventListener('click', () => {
        inst.style.display = 'none';
        startBlock();
      });
    }

    // --------------------------------------
    // BLOCK & TRIAL FLOW
    // --------------------------------------
    function startBlock() {
      trialIndex = 0;
      document.getElementById('task-ui').style.display = 'flex';
      loadTrial();
    }

    function loadTrial() {
      const blockNum = blockIndex + 1;
      const problemNum = trialIndex + 1;
      const type = blocks[blockIndex];
      currentPrompt = (type === 'move' ? movePrompts : changePrompts)[trialIndex];
      currentState = structuredClone(blockData[type][trialIndex]);
      userActions = [];
      problemStartTime = Date.now();
      startRecording(blockNum, problemNum);
      VoiceFeedback.start();
      const numCities = (currentPrompt?.cities || []).length;
      const limitMs   = getTrialLimitMsFromCities(numCities);
      renderUI(type, limitMs);
      trialActive = true;
      startTrialTimer(limitMs);  // timer runs invisibly; still enforces time limit
    }

    // --------------------------------------
    // RENDERING — MOVE/CHANGE BLOCKS
    // --------------------------------------
    function renderUI(type, limitMs) {
      const container = document.getElementById('task-ui');

      // Left column = instructions + problem prompt

      const instructionsHTML = `
        <div class="rules-text">
          <h3>Instructions</h3>
          <p>In this experiment, you will be presented with sets of cities. Your goal is to find the shortest path between two cities in the specified layout</p>
        </div>
        <div id="problem-prompt" class="stim-prompt">
          ${currentPrompt?.prompt || ''}
        </div>
      `;


      const cities = currentPrompt?.cities || ['City 1','City 2','City 3','City 4','City 5'];

      container.innerHTML = `
        <div class="left-column">${instructionsHTML}</div>
        <div class="right-column" style="justify-content:flex-start;">
          <div id="trial-timer" class="trial-timer" aria-live="polite">${formatClock(limitMs)}</div>

          <textarea id="trial-notes"
            aria-label="Notes for this trial"
            placeholder="Type your thoughts here…"
            class="notes-textarea"
            style="margin-top:12px;"></textarea>

          <div class="center" style="margin-top:12px;">
            <button id="done-button" class="done-button">Continue</button>
          </div>
        </div>
      `;

      // Continue ends the trial immediately (no gating on path selection)
      const doneBtn = container.querySelector('#done-button');
      doneBtn.addEventListener('click', () => {
        endTrial('user');
      });
    }

    // --------------------------------------
    // END OF TRIAL / BLOCK / STUDY
    // --------------------------------------
    function endTrial(reason = 'user') {
      if (!trialActive) return;
      trialActive = false;
      clearTrialTimer();

      // capture notes now (works for both user click and timeout)
      const trialNotes = (document.getElementById('trial-notes')?.value || '').trim();

      stopRecording(async () => {
        await VoiceFeedback.stop();

        const type = blocks[blockIndex];
        allProblemLogs.push({
          blockType: type,
          trialIndex: trialIndex + 1,
          promptId: currentPrompt?.id || null,
          actions: userActions,
          startTime: problemStartTime,
          endTime: Date.now(),
          endedBy: reason,
          notes: trialNotes
        });

        trialIndex++;
        if (trialIndex < N) loadTrial();
        else {
          blockIndex++;
          if (blockIndex < 2) {
            document.getElementById('task-ui').style.display = 'none';
            loadBlock();
          } else {
            finishStudy();
          }
        }
      });
    }


    async function finishStudy() {
      if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});
      document.getElementById('task-ui').style.display = 'none';

      const end = document.getElementById('end-screen');
      const puzzleData = { participantData, puzzleLogs: allProblemLogs };
      const timestamp = Date.now();
      const participantId = `P_${timestamp}_${Math.random().toString(36).substr(2, 9)}`;

      try {
        // Save to Firebase
        try {
          // 1. Upload audio files to Storage
          for (const {block, trial, blob} of audioChunks) {
            const audioFileName = `audio/${participantId}/block${block}_problem${trial}.webm`;
            const audioRef = ref(storage, audioFileName);
            await uploadBytes(audioRef, blob);
          }

          // 2. Save experiment data to Firestore
          const experimentData = {
            participantId,
            timestamp: serverTimestamp(),
            clientTimestamp: timestamp,
            participantData,
            puzzleLogs: allProblemLogs,
            audioFileCount: audioChunks.length,
            userAgent: navigator.userAgent
          };

          const docRef = await addDoc(collection(db, 'experiments'), experimentData);
          console.log('Data saved to Firebase with ID:', docRef.id);

        } catch (firebaseError) {
          console.error('Firebase save failed:', firebaseError);
          showError('Could not save to Firebase; will save locally instead.');
        }

        // Always create local ZIP as backup
        const zip = new JSZip();
        zip.file("puzzle_data.json", JSON.stringify(puzzleData, null, 2));
        audioChunks.forEach(({ block, trial, blob }) => {
          zip.file(`block${block}_problem${trial}.webm`, blob);
        });
        const zipBlob = await zip.generateAsync({ type: "blob" });
        saveAs(zipBlob, "combined_task_data_with_audio.zip");

      } catch (err) {
        console.error('Error in finishStudy:', err);
        showError('Some data saving failed, but study is complete.');
      } finally {
        end.style.display = 'block';
        end.setAttribute('tabindex', '-1');
        end.focus();
        document.addEventListener('keydown', onEndScreenKey, { once: true });
      }
    }

    function onEndScreenKey() {
      document.removeEventListener('keydown', onEndScreenKey);
      const end = document.getElementById('end-screen');
      end.innerHTML = `
        <p style="margin-bottom:16px; font-size:18px;">
          User pressed a key on end screen—trigger payment logic here!
        </p>
        <p style="font-size:14px; opacity:.8;">
          (This is where you’d redirect to your completion URL or call your payment API.)
        </p>
      `;
      // e.g. window.location.href = 'https://your-completion-url';
    }

    // --------------------------------------
    // START
    // --------------------------------------
    startIntro();
  </script>
  <footer class="site-footer">
    <div class="footer-content">
      <a href="https://support.microsoft.com/contactus">Contact Us</a>
      <a href="https://go.microsoft.com/fwlink/?LinkId=521839">Privacy & Cookies</a>
      <a href="https://go.microsoft.com/fwlink/?LinkID=246338">Terms of Use</a>
      <a href="https://go.microsoft.com/fwlink/?linkid=2196228%20">Trademarks</a>
      <span>© 2025 Microsoft</span>
    </div>
  </footer>
</body>
</html>